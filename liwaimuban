import pandas as pd
import os
from datetime import datetime, timedelta
import streamlit as st
import io


# ========================= è¾…åŠ©å‡½æ•° =========================
def safe_num(x):
    try:
        return float(x)
    except:
        return 0


def find_col(columns, target):
    # æ¨¡ç³ŠåŒ¹é…åˆ—åï¼ˆé˜²æ­¢å¤šä½™ç©ºæ ¼ï¼‰
    for c in columns:
        if target in c.replace(" ", "").replace("\u3000", "").replace("\xa0", ""):
            return c
    raise KeyError(f"âŒ æœªæ‰¾åˆ°åˆ—ï¼š{target}")


# ========================= å¤„ç†å‡½æ•° =========================
def process_files(data_file, template_file):
    """å¤„ç†ä¸Šä¼ çš„æ–‡ä»¶"""
    today = datetime.today()
    today_str = today.strftime("%Y-%m-%d")
    future_25 = today + timedelta(days=25)
    future_21 = today + timedelta(days=21)

    try:
        # è¯»å–æ•°æ®æ–‡ä»¶
        df = pd.read_excel(data_file, sheet_name="ä¾‹å¤–ä¿¡æ¯è‡ªåŠ¨è®¡ç®—")
        df.columns = df.columns.astype(str).str.strip().str.replace('\u3000', '').str.replace('\xa0', '')

        # æ˜¾ç¤ºåˆ—åç”¨äºè°ƒè¯•
        st.info(f"æ•°æ®æ–‡ä»¶åˆ—å: {list(df.columns)}")

        # è¯»å–æ¨¡æ¿æ–‡ä»¶
        template = pd.read_excel(template_file)

        # ========== ç²¾ç¡®åˆ—ååŒ¹é… ==========
        col_pl = find_col(df.columns, "PL")
        col_item = find_col(df.columns, "ITEM")
        col_cancel_final = find_col(df.columns, "å–æ¶ˆæ•°é‡-æœ€ç»ˆ")
        col_delay_final = find_col(df.columns, "æ¨è¿Ÿæ•°é‡-æœ€ç»ˆ")
        col_cpd_day = find_col(df.columns, "cpdå¤©")
        col_rpd_date = find_col(df.columns, "RPDå‘¨æœ€ç»ˆç¡®è®¤")
        col_transport = find_col(df.columns, "è¿è¾“æ–¹å¼")

        st.success("âœ… æ‰€æœ‰å¿…éœ€çš„åˆ—éƒ½å·²æ‰¾åˆ°")

        # ========== å–æ¶ˆä¾‹å¤– ==========
        cancel_rows = []
        for _, row in df.iterrows():
            cancel_final = safe_num(row[col_cancel_final])
            if cancel_final != 0:
                pl = str(row[col_pl])
                item = row[col_item]
                batch = pl[-8:] if len(pl) >= 8 else pl
                contract = pl[:14] if len(pl) >= 14 else pl
                cancel_rows.append({
                    "*Site": "SS6",
                    "*ä¾‹å¤–æ•°é‡": cancel_final,
                    "*Item": item,
                    "*æ›´æ–°ååˆ°è´§æ—¥æœŸ": today_str,
                    "*å›¤è´§åˆåŒå·": contract,
                    "å‘è´§æ‰¹æ¬¡": batch,
                    "å‘è¿é›†": f"{batch}01N",
                    "*ä¾‹å¤–ç±»åˆ«": "Cancel"
                })

        # ========== æ¨è¿Ÿä¾‹å¤– ==========
        delay_rows = []
        manual_rows = []

        for _, row in df.iterrows():
            delay_final = safe_num(row[col_delay_final])
            if delay_final == 0:
                continue

            cpd_day = safe_num(row[col_cpd_day])
            transport = str(row[col_transport]).strip().lower()
            rpd_date_raw = row[col_rpd_date]

            try:
                rpd_date = pd.to_datetime(rpd_date_raw)
            except:
                rpd_date = None

            # åˆ¤æ–­RPDæ˜¯å¦åœ¨æœªæ¥21å¤©å†…
            rpd_in_21_days = (rpd_date is not None) and (rpd_date <= future_21)

            # æ¨è¿Ÿæ—¥æœŸè®¡ç®—
            if "sea" in transport:
                new_date = today + timedelta(days=32 + 25)
            elif "air" in transport:
                new_date = today + timedelta(days=10 + 25)
            else:
                new_date = today + timedelta(days=25)
            new_date_str = new_date.strftime("%Y-%m-%d")

            pl = str(row[col_pl])
            item = row[col_item]
            batch = pl[-8:] if len(pl) >= 8 else pl
            contract = pl[:14] if len(pl) >= 14 else pl

            row_dict = {
                "*Site": "SS6",
                "*ä¾‹å¤–æ•°é‡": delay_final,
                "*Item": item,
                "*æ›´æ–°ååˆ°è´§æ—¥æœŸ": new_date_str,
                "*å›¤è´§åˆåŒå·": contract,
                "å‘è´§æ‰¹æ¬¡": batch,
                "å‘è¿é›†": f"{batch}01N",
                "*ä¾‹å¤–ç±»åˆ«": "De-Expedite"
            }

            if cpd_day <= future_25.day and rpd_in_21_days:
                delay_rows.append(row_dict)
            elif cpd_day > future_25.day:
                manual_rows.append(row_dict)

        return cancel_rows, delay_rows, manual_rows, template

    except Exception as e:
        st.error(f"å¤„ç†æ–‡ä»¶æ—¶å‡ºé”™: {str(e)}")
        import traceback
        st.error(traceback.format_exc())
        return None, None, None, None


def create_download_files(data_rows, name_prefix, template):
    """åˆ›å»ºå¯ä¸‹è½½çš„æ–‡ä»¶"""
    if not data_rows:
        return []

    files = []
    chunk_size = 170

    for i in range(0, len(data_rows), chunk_size):
        part = data_rows[i:i + chunk_size]
        df_out = pd.DataFrame(part)

        # ç¡®ä¿åˆ—é¡ºåºä¸æ¨¡æ¿ä¸€è‡´
        df_out = df_out.reindex(columns=template.columns, fill_value="")

        # åˆ›å»ºExcelæ–‡ä»¶åœ¨å†…å­˜ä¸­
        output = io.BytesIO()
        with pd.ExcelWriter(output, engine='openpyxl') as writer:
            df_out.to_excel(writer, index=False)
        output.seek(0)

        files.append({
            'data': output,
            'name': f"{name_prefix}_{i // chunk_size + 1}.xlsx"
        })

    return files


# ========================= Streamlitç•Œé¢ =========================
def main():
    st.set_page_config(
        page_title="ä¾‹å¤–å¤„ç†å·¥å…·",
        page_icon="ğŸ“Š",
        layout="wide"
    )

    st.title("ğŸ“Š ä¾‹å¤–å¤„ç†å·¥å…·")
    st.markdown("""
    è¿™ä¸ªå·¥å…·ç”¨äºå¤„ç†ä¾‹å¤–æ•°æ®å¹¶ç”Ÿæˆç›¸åº”çš„è¾“å‡ºæ–‡ä»¶ã€‚

    **ä½¿ç”¨æ­¥éª¤:**
    1. ä¸Šä¼ æ•°æ®æ–‡ä»¶ (åŒ…å«ä¾‹å¤–ä¿¡æ¯è‡ªåŠ¨è®¡ç®—çš„å·¥ä½œè¡¨)
    2. ä¸Šä¼ æ¨¡æ¿æ–‡ä»¶
    3. ç‚¹å‡»"å¤„ç†æ–‡ä»¶"æŒ‰é’®
    4. ä¸‹è½½ç”Ÿæˆçš„ç»“æœæ–‡ä»¶

    **æ³¨æ„ï¼š**
    - æ•°æ®æ–‡ä»¶å¿…é¡»åŒ…å«åä¸º"ä¾‹å¤–ä¿¡æ¯è‡ªåŠ¨è®¡ç®—"çš„å·¥ä½œè¡¨
    - æ¯ä¸ªè¾“å‡ºæ–‡ä»¶æœ€å¤š170è¡Œæ•°æ®
    - å¦‚æœæ•°æ®é‡å¾ˆå¤§ï¼Œä¼šè‡ªåŠ¨åˆ†å‰²æˆå¤šä¸ªæ–‡ä»¶
    """)

    # æ–‡ä»¶ä¸Šä¼ 
    col1, col2 = st.columns(2)

    with col1:
        data_file = st.file_uploader(
            "ä¸Šä¼ æ•°æ®æ–‡ä»¶",
            type=['xlsx'],
            help="åŒ…å«'ä¾‹å¤–ä¿¡æ¯è‡ªåŠ¨è®¡ç®—'å·¥ä½œè¡¨çš„Excelæ–‡ä»¶"
        )

    with col2:
        template_file = st.file_uploader(
            "ä¸Šä¼ æ¨¡æ¿æ–‡ä»¶",
            type=['xlsx'],
            help="æ¨¡æ¿Excelæ–‡ä»¶"
        )

    # å¤„ç†æŒ‰é’®
    if st.button("ğŸš€ å¤„ç†æ–‡ä»¶", type="primary"):
        if data_file is None or template_file is None:
            st.error("è¯·å…ˆä¸Šä¼ ä¸¤ä¸ªæ–‡ä»¶")
            return

        with st.spinner("æ­£åœ¨å¤„ç†æ–‡ä»¶..."):
            cancel_rows, delay_rows, manual_rows, template = process_files(data_file, template_file)

            if cancel_rows is not None:
                # æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
                st.subheader("ğŸ“Š å¤„ç†ç»“æœç»Ÿè®¡")
                col1, col2, col3 = st.columns(3)
                with col1:
                    st.metric("å–æ¶ˆä¾‹å¤–", len(cancel_rows))
                with col2:
                    st.metric("æ¨è¿Ÿä¾‹å¤–", len(delay_rows))
                with col3:
                    st.metric("æ‰‹å·¥ä¾‹å¤–", len(manual_rows))

                # ç”Ÿæˆä¸‹è½½æ–‡ä»¶
                st.subheader("ğŸ“¥ ä¸‹è½½ç»“æœæ–‡ä»¶")

                # å–æ¶ˆä¾‹å¤–æ–‡ä»¶
                if cancel_rows:
                    cancel_files = create_download_files(cancel_rows, "å–æ¶ˆä¾‹å¤–", template)
                    st.write("**å–æ¶ˆä¾‹å¤–æ–‡ä»¶:**")
                    for file_info in cancel_files:
                        st.download_button(
                            label=f"ä¸‹è½½ {file_info['name']}",
                            data=file_info['data'],
                            file_name=file_info['name'],
                            mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                            key=f"cancel_{file_info['name']}"
                        )

                # æ¨è¿Ÿä¾‹å¤–æ–‡ä»¶
                if delay_rows:
                    delay_files = create_download_files(delay_rows, "æ¨è¿Ÿä¾‹å¤–", template)
                    st.write("**æ¨è¿Ÿä¾‹å¤–æ–‡ä»¶:**")
                    for file_info in delay_files:
                        st.download_button(
                            label=f"ä¸‹è½½ {file_info['name']}",
                            data=file_info['data'],
                            file_name=file_info['name'],
                            mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                            key=f"delay_{file_info['name']}"
                        )

                # æ‰‹å·¥ä¾‹å¤–æ–‡ä»¶
                if manual_rows:
                    manual_files = create_download_files(manual_rows, "æ‰‹å·¥ä¾‹å¤–", template)
                    st.write("**æ‰‹å·¥ä¾‹å¤–æ–‡ä»¶:**")
                    for file_info in manual_files:
                        st.download_button(
                            label=f"ä¸‹è½½ {file_info['name']}",
                            data=file_info['data'],
                            file_name=file_info['name'],
                            mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                            key=f"manual_{file_info['name']}"
                        )

                if not cancel_rows and not delay_rows and not manual_rows:
                    st.info("æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„ä¾‹å¤–æ•°æ®")

                st.success("ğŸ‰ æ–‡ä»¶å¤„ç†å®Œæˆï¼")


# ========================= è¿è¡Œ =========================
if __name__ == "__main__":
    main()
